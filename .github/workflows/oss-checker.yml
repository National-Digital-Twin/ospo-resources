# SPDX-License-Identifier: Apache-2.0
# Â© Crown Copyright 2025. This work has been developed by the National Digital Twin Programme and is legally attributed to the Department for Business and Trade (UK) as the governing entity.

name: Run OSS check helper

on:
  pull_request:
    types:
      - opened
      - synchronize
      - reopened
      - labeled
      - unlabeled
  workflow_dispatch:

permissions:
  contents: read

jobs:
  oss-checks:
    if: github.actor != 'dependabot[bot]' && 
      (github.event.repository.private == false ||
        (github.event.repository.private == true &&
         contains(join(github.event.pull_request.labels.*.name), 'oss-preparation')))
    runs-on: ubuntu-latest

    steps:
      - name: Fetch GitHub App token for target repo
        id: target_token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ secrets.OSPO_WORKFLOW_APP_ID }}
          private-key: ${{ secrets.OSPO_WORKFLOW_PRIVATE_KEY }}
          permission-contents: read

      - name: Fetch GitHub App token for OSPO source repo (read-only)
        id: ospo_token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ secrets.OSPO_WORKFLOW_APP_ID }}
          private-key: ${{ secrets.OSPO_WORKFLOW_PRIVATE_KEY }}
          owner: National-Digital-Twin
          repositories: ospo-resources
          permission-contents: read

      - name: Checkout target repository
        uses: actions/checkout@v6
        with:
          token: ${{ steps.target_token.outputs.token }}

      - name: Checkout OSPO source repository
        uses: actions/checkout@v6
        with:
          repository: National-Digital-Twin/ospo-resources
          path: ospo-resources
          token: ${{ steps.ospo_token.outputs.token }}

      - name: Checkout archetypes source repository
        uses: actions/checkout@v6
        with:
          repository: National-Digital-Twin/archetypes
          path: archetypes

      - name: Test for presence of OSS files and variation from templated content
        uses: actions/github-script@v8
        with:
          script: |
            const { existsSync, readFileSync } = require('fs');

            const checklistPath = 'ospo-resources/oss-checklist-files.txt';
            const checklist = readFileSync(checklistPath, 'utf8')
              .split('\n')
              .map((line) => line.trim())
              .filter((line) => line && !line.startsWith('#'));

            const missingFiles = [];
            const unchangedFiles = [];

            for (const relativePath of checklist) {
              const targetPath = relativePath;
              const archetypePath = `archetypes/${relativePath}`;

              if(!existsSync(targetPath)) {
                core.info(`Missing OSS file in target repository: ${targetPath}`);
                missingFiles.push(relativePath);
                continue;
              }

              const targetContent = readFileSync(targetPath, 'utf8');
              const archetypeContent = existsSync(archetypePath)
                ? readFileSync(archetypePath, 'utf8')
                : null;

              if (archetypeContent !== null && targetContent === archetypeContent) {
                core.info(`OSS file unchanged from archetypes template: ${targetPath}`);
                unchangedFiles.push(relativePath);
              }

              core.info(`OSS file present and different from the archetypes template: ${targetPath}`);
            }

            if (missingFiles.length > 0) {
              core.info('The following OSS required files are missing:');
              missingFiles.forEach((file) => core.info(file));
            }

            if (unchangedFiles.length > 0) {
              core.info('The following OSS required files are unchanged from the archetypes template:');
              unchangedFiles.forEach((file) => core.info(file));
            }

            if (missingFiles.length > 0 || unchangedFiles.length > 0) {
              core.setFailed('OSS required file check failed.');
            } else {
              core.info('All OSS files are present and have been updated from their original templated content.');
            }

      - name: Check GitHub template files are present
        uses: actions/github-script@v8
        with:
          script: |
            const { existsSync } = require('fs');

            core.info('Checking for pull request and issue template files');

            const filesToCheck = [
              '.github/PULL_REQUEST_TEMPLATE.md',
              '.github/ISSUE_TEMPLATE/bug_report.md',
              '.github/ISSUE_TEMPLATE/feature_request.md',
            ];

            const missingTemplates = filesToCheck.filter((file) => !existsSync(file));

            if (missingTemplates.length > 0) {
              core.info('');
              core.info('Required GitHub template files not found:');
              missingTemplates.forEach((file) => core.info(`  - ${file}`));
              core.info('');
              core.info('These files help improve project collaboration and are considered best practice.');
              core.info('These need to be included in repository contents to improve the developer and repository consumer experience.');
              core.setFailed('Missing required GitHub template files.');
            } else {
              core.info('Required pull request and issue template files present.');
            }
