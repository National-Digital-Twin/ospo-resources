# SPDX-License-Identifier: Apache-2.0
# Â© Crown Copyright 2025. This work has been developed by the National Digital Twin Programme and is legally attributed to the Department for Business and Trade (UK) as the governing entity.

name: CI

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop
      - 'release/**'
      - 'hotfix/**'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:

  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest

    permissions:
      pull-requests: read

    outputs:
      run_pac_ci: >-
        ${{ (github.event_name == 'pull_request' && steps.pac-changes.outputs.pac ) ||
         github.event_name == 'workflow_dispatch' ||
         (github.event_name == 'push' && github.ref_name == 'main' || github.ref_name == 'develop') }}
    steps:
      - name: Checkout code
        if: github.event_name == 'pull_request'
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3.0.2
        name: detect policy-as-code changes
        if: github.event_name == 'pull_request'
        id: pac-changes
        with:
          filters: |
            pac:
              - 'tools/policy-as-code/**'

  lint-policies:
    permissions:
      contents: read

    name: Lint Policies
    runs-on: ubuntu-latest

    needs: detect-changes
    if: needs.detect-changes.outputs.run_pac_ci == 'true'

    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Setup OPA
        uses: open-policy-agent/setup-opa@950f159a49aa91f9323f36f1de81c7f6b5de9576 # v2.3.0
        with:
          version: latest

      - name: Setup Regal
        uses: open-policy-agent/setup-regal@33a142b1189004e0f14bf42b15972c67eecce776 # v1.0.0
        with:
          version: latest

      - name: OPA Check (Strict)
        run: | 
          opa check --strict tools/policy-as-code/policy

      - name: Regal Lint (github format)
        run: |
          mkdir -p test-results
          regal lint -f github tools/policy-as-code/policy

      - name: Regal Lint (sarif format)
        if: success() || failure()
        run: |
          mkdir -p test-results
          regal lint -f sarif tools/policy-as-code/policy -o test-results/lint-results.sarif

      - name: Upload linting results
        if: success() || failure()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: pac-linting-report
          path: test-results/lint-results.sarif

  test-policies:
    permissions:
      contents: read

    needs: detect-changes
    if: needs.detect-changes.outputs.run_pac_ci == 'true'

    name: Test Policies
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Setup OPA
        uses: open-policy-agent/setup-opa@950f159a49aa91f9323f36f1de81c7f6b5de9576 # v2.3.0
        with:
          version: latest

      - name: Run OPA Tests and Generate Reports
        run: |
          # Create output directory
          mkdir -p test-results
          mkdir -p tmp

          opa test --format=json tools/policy-as-code/policy > tmp/test-results.json

          # 1. GENERATE TEST RESULTS (JUnit XML)
          # Convert JSON results to JUnit XML using jq
           jq -r '
            "<testsuites time=\"\((map(.duration) | add // 0) / 1000000000)\">
               <testsuite name=\"OPA\" tests=\"\(length)\" failures=\"\(map(select(.fail)) | length)\" time=\"\((map(.duration) | add // 0) / 1000000000)\">
                 \(map("<testcase name=\"\(.name)\" classname=\"\(.package)\" time=\"\(.duration/1000000000)\">\(if .fail then "<failure message=\"Test failed\"/>" else "" end)</testcase>") | join(""))
               </testsuite>
             </testsuites>"
          ' tmp/test-results.json > test-results/test-results-junit.xml

          # 2. GENERATE TEST EXECUTION REPORT (Generic Test Data for SonarQube)
          # Convert OPA JSON test results to Sonar Generic Execution XML format
          jq -r '
            "<testExecutions version=\"1\">" +
            (
              [
                group_by(.location.file)[] |
                "<file path=\"\(.[0].location.file)\">" +
                (
                  map(
                    "<testCase name=\"\(.name)\" duration=\"\((.duration / 1000000) | floor)\">" +
                    (if .fail then "<failure message=\"Test failed\"/>" else "" end) +
                    "</testCase>"
                  ) | join("")
                ) +
                "</file>"
              ] | join("")
            ) +
            "</testExecutions>"
          ' tmp/test-results.json > test-results/test-results.xml

          # 3. GENERATE COVERAGE REPORT (Generic Test Data)
          # Convert OPA JSON coverage to Sonar Generic XML format
          opa test --coverage --format=json tools/policy-as-code/policy | jq -r '
            "<coverage version=\"1\">" +
            (
              [
                .files | to_entries[] |
                "<file path=\"\(.key)\">" +
                (
                  [
                    (.value.covered[]? | range(.start.row; .end.row + 1) | "<lineToCover lineNumber=\"\(.)\" covered=\"true\"/>"),
                    (.value.not_covered[]? | range(.start.row; .end.row + 1) | "<lineToCover lineNumber=\"\(.)\" covered=\"false\"/>")
                  ] | join("")
                ) +
                "</file>"
              ] | join("")
            ) +
            "</coverage>"
          ' > test-results/coverage.xml

      - name: Upload test reports
        if: success() || failure()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: pac-test-report
          path: test-results/

  publish-results:
    permissions:
      contents: read
      security-events: write

    needs:
      - lint-policies
      - test-policies

    if: always()

    name: Publish Reports
    runs-on: ubuntu-latest
    steps:

      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0

      - uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          pattern: 'pac-*-report'
          path: test-results
          merge-multiple: true

      - name: Detect reports exist
        id: results-check
        run: |
          HAS_SARIF=$([ -f "test-results/lint-results.sarif" ] && echo "true" || echo "false")
          HAS_UNIT=$([ -f "test-results/test-results.xml" ] && echo "true" || echo "false")

          echo "sarif-reports=$HAS_SARIF" >> $GITHUB_OUTPUT
          echo "unit-reports=$HAS_UNIT" >> $GITHUB_OUTPUT

      - name: Upload SARIF file
        if: |
          github.event.repository.visibility == 'public' &&
          steps.results-check.outputs.sarif-reports == 'true'
        uses: github/codeql-action/upload-sarif@6bc82e05fd0ea64601dd4b465378bbcf57de0314 # v4.32.1
        with:
          sarif_file: test-results/lint-results.sarif
          category: regal-lint

      - name: SonarQube Scan
        uses: SonarSource/sonarqube-scan-action@a31c9398be7ace6bbfaf30c0bd5d415f843d45e9 # v7.0.0
        if: always()
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

      - name: Publish Test Results
        uses: dorny/test-reporter@b082adf0eced0765477756c2a610396589b8c637 # v2.5.0
        if: |
          always() &&
          steps.results-check.outputs.unit-reports == 'true'
        with:
          name: OPA Test Results
          path: test-results/test-results-junit.xml
          reporter: java-junit
