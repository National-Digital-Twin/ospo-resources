# SPDX-License-Identifier: Apache-2.0
# Â© Crown Copyright 2025. This work has been developed by the National Digital Twin Programme and is legally attributed to the Department for Business and Trade (UK) as the governing entity.

name: CI

on:
  push:
    branches:
      - main
      - develop
      - 'release/**'
      - 'hotfix/**'
  pull_request:
    branches:
      - main
      - develop

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:

  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest

    permissions:
      contents: read

    outputs:
      run_pac_ci: ${{ steps.pac-changes.outputs.pac }}
    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3.0.2
        name: detect policy-as-code changes
        id: pac-changes
        with:
          filters: |
            pac:
              - 'tools/policy-as-code/**'

  lint-policies:
    permissions:
      contents: read

    name: Lint Policies
    runs-on: ubuntu-latest

    needs: detect-changes
    if: needs.detect-changes.outputs.run_pac_ci == 'true'

    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Setup OPA
        uses: open-policy-agent/setup-opa@34a30e8a924d1b03ce2cf7abe97250bbb1f332b5 # v2.2.0
        with:
          version: latest

      - name: Setup Regal
        uses: open-policy-agent/setup-regal@33a142b1189004e0f14bf42b15972c67eecce776 # v1.0.0
        with:
          version: latest

      - name: OPA Check (Strict)
        run: | 
          opa check --strict tools/policy-as-code/policy

      - name: Regal Lint (github format)
        run: |
          mkdir -p test-results
          regal lint -f github tools/policy-as-code/policy

      - name: Regal Lint (sarif format)
        if: success() || failure()
        run: |
          mkdir -p test-results
          regal lint -f sarif tools/policy-as-code/policy -o test-results/lint-results.sarif

      - name: Upload linting results
        if: success() || failure()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: pac-linting-report
          path: test-results/lint-results.sarif

  test-policies:
    permissions:
      contents: read

    needs: detect-changes
    if: needs.detect-changes.outputs.run_pac_ci == 'true'

    name: Test Policies
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Setup OPA
        uses: open-policy-agent/setup-opa@34a30e8a924d1b03ce2cf7abe97250bbb1f332b5 # v2.2.0
        with:
          version: latest

      - name: Run OPA Tests and Generate Reports
        run: |
          # Create output directory
          mkdir -p test-results

          # 1. GENERATE TEST RESULTS (JUnit XML)
          # Convert JSON results to JUnit XML using jq
          opa test --format=json tools/policy-as-code/policy | jq -r '
            "<testsuites time=\"\((map(.duration) | add // 0) / 1000000000)\">
               <testsuite name=\"OPA\" tests=\"\(length)\" failures=\"\(map(select(.fail)) | length)\" time=\"\((map(.duration) | add // 0) / 1000000000)\">
                 \(map("<testcase name=\"\(.name)\" classname=\"\(.package)\" time=\"\(.duration/1000000000)\">\(if .fail then "<failure message=\"Test failed\"/>" else "" end)</testcase>") | join(""))
               </testsuite>
             </testsuites>"
          ' > test-results/test-results.xml

          # 2. GENERATE COVERAGE REPORT (LCOV)
          # Convert OPA JSON coverage to LCOV format using jq
          opa test --coverage --format=json tools/policy-as-code/policy | jq -r '
            .files | to_entries[] | 
            "SF:" + .key,
            (.value.covered[]? | range(.start.row; .end.row + 1) | "DA:" + (.|tostring) + ",1"),
            (.value.not_covered[]? | range(.start.row; .end.row + 1) | "DA:" + (.|tostring) + ",0"),
            "end_of_record"
          ' > test-results/lcov.info

      - name: Upload test reports
        if: success() || failure()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: pac-test-report
          path: test-results/

  publish-results:
    permissions:
      contents: read
      security-events: write

    needs:
      - lint-policies
      - test-policies

    if: always()

    name: Publish Reports
    runs-on: ubuntu-latest
    steps:

      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          pattern: 'pac-*-report'
          path: test-results
          merge-multiple: true

      - name: Detect reports exist
        id: results-check
        run: |
          HAS_SARIF=$([ -f "test-results/lint-results.sarif" ] && echo "true" || echo "false")
          HAS_UNIT=$([ -f "test-results/test-results.xml" ] && echo "true" || echo "false")

          echo "sarif-reports=$HAS_SARIF" >> $GITHUB_OUTPUT
          echo "unit-reports=$HAS_UNIT" >> $GITHUB_OUTPUT

      - name: Upload SARIF file
        if: |
          github.event.repository.visibility == 'public' &&
          steps.results-check.outputs.sarif-reports == 'true'
        uses: github/codeql-action/upload-sarif@b20883b0cd1f46c72ae0ba6d1090936928f9fa30 # v4.32.0
        with:
          sarif_file: test-results/lint-results.sarif
          category: regal-lint

      - name: SonarQube Scan
        uses: SonarSource/sonarqube-scan-action@a31c9398be7ace6bbfaf30c0bd5d415f843d45e9 # v7.0.0
        if: always()
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

      - name: Publish Test Results
        uses: dorny/test-reporter@b082adf0eced0765477756c2a610396589b8c637 # v2.5.0
        if: |
          always() &&
          steps.results-check.outputs.unit-reports == 'true'
        with:
          name: OPA Test Results
          path: test-results/test-results.xml
          reporter: java-junit
