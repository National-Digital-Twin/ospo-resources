# SPDX-License-Identifier: Apache-2.0
# Â© Crown Copyright 2026. This work has been developed by the National Digital Twin Programme and is legally attributed to the Department for Business and Trade (UK) as the governing entity.

name: Fork - Intermediate Sync

on:
  push:
    branches:
      - develop

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  intermediate-branch-sync:
    runs-on: ubuntu-latest
    # This job only runs if the repository is a fork
    if: github.event.repository.fork == true
    steps:
      - name: Generate Sync Token
        id: sync-token
        uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # v2.2.1
        with:
          app-id: ${{ secrets.NDTP_REPOSITORY_WRITER_APP_CLIENT_ID }}
          private-key: ${{ secrets.NDTP_REPOSITORY_WRITER_APP_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}
          repositories: |
            ${{ github.event.repository.name }}
          permission-contents: write
          permission-workflows: write

      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          ref: develop
          token: ${{ steps.sync-token.outputs.token }}

      - name: Configure Git
        env:
          GITHUB_APP_USERNAME: '${{ steps.sync-token.outputs.app-slug }}[bot]'
          GITHUB_APP_EMAIL: '${{ steps.sync-token.outputs.user-id }}+${{ steps.sync-token.outputs.app-slug }}[bot]@users.noreply.github.com'
        run: |
          git config user.name "$GITHUB_APP_USERNAME"
          git config user.email "$GITHUB_APP_EMAIL"

      - name: Sync intermediate branch
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          script: |
            try {
              core.info("Force pushing current develop state to intermediate-sync");
              
              // Push develop to intermediate-sync with force
              // This creates the branch if it doesn't exist, or overwrites it if it does
              // We use HEAD (which is develop) to push to refs/heads/intermediate-sync
              await exec.exec('git', ['push', 'origin', 'HEAD:refs/heads/intermediate-sync', '--force']);

              await core.summary
                .addHeading('Sync Complete :white_check_mark:')
                .addRaw('Successfully force-pushed `develop` to `intermediate-sync`.')
                .write();

            } catch (error) {
              const codeBlock = '```';
              const errorMessage = `${codeBlock}text
              ${error.message}
              ${codeBlock}\n`;

              await core.summary
                .addRaw('## Sync Failed :alarm:')
                .addRaw('Failed to force-push `develop` to `intermediate-sync`:\n', true)
                .addRaw(errorMessage, true)
                .write();

              core.setFailed(`Sync failed: ${error.message}`);
            }
