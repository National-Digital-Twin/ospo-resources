# SPDX-License-Identifier: Apache-2.0
# © Crown Copyright 2026. This work has been developed by the National Digital Twin Programme and is legally attributed to the Department for Business and Trade (UK) as the governing entity.

name: Fork - Intermediate Merge

on:
  pull_request:
    types: [closed]
    branches:
      - intermediate-sync

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  merge-intermediate-to-develop:
    runs-on: ubuntu-latest
    # This job only runs if the repository is a fork and the PR was merged
    if: github.event.repository.fork == true && github.event.pull_request.merged == true
    steps:
      - name: Generate Sync Token
        id: sync-token
        uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # v2.2.1
        with:
          app-id: ${{ secrets.NDTP_REPOSITORY_WRITER_APP_CLIENT_ID }}
          private-key: ${{ secrets.NDTP_REPOSITORY_WRITER_APP_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}
          repositories: |
            ${{ github.event.repository.name }}
          permission-contents: write
          permission-workflows: write

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history for merge
          ref: develop
          token: ${{ steps.sync-token.outputs.token }}

      - name: Configure Git
        env:
          GITHUB_APP_USERNAME: ${{ steps.sync-token.outputs.app-slug }}[bot]
          GITHUB_APP_EMAIL: ${{ steps.sync-token.outputs.user-id }}+${{ steps.sync-token.outputs.app-slug }}[bot]@users.noreply.github.com
        run: |
          git config user.name "$GITHUB_APP_USERNAME"
          git config user.email "$GITHUB_APP_EMAIL"

      - name: Merge intermediate-sync into develop
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          script: |
            const prUrl = context.payload.pull_request.html_url;
            const prTitle = context.payload.pull_request.title;
            const prNumber = context.payload.pull_request.number;

            try {
              core.info("Fetching intermediate-sync branch");
              await exec.exec('git', ['fetch', 'origin', 'intermediate-sync']);

              core.info("Merging intermediate-sync into develop");
              // Merge intermediate-sync into develop creating a merge commit if necessary
              await exec.exec('git', ['merge', 'origin/intermediate-sync', '--no-edit']);

              core.info("Pushing develop");
              await exec.exec('git', ['push', 'origin', 'develop']);

              await core.summary
                .addHeading('Merge Complete :white_check_mark:')
                .addRaw('Successfully merged `intermediate-sync` into `develop`.\n', true)
                .addRaw(`Triggered by PR: [${prTitle} (#${prNumber})](${prUrl})`)
                .write();

            } catch (error) {
              const codeBlock = '```';
              const errorMessage = `${codeBlock}text
              ${error.message}
              ${codeBlock}\n`;

              await core.summary
                .addHeading('Merge Failed :alarm:')
                .addRaw(`Failed to merge \`intermediate-sync\` into \`develop\`:\n`, true)
                .addRaw(errorMessage, true)
                .addRaw(`\nTriggered by PR: [${prTitle} (#${prNumber})](${prUrl})`)
                .write();
                
              core.setFailed(`Merge failed: ${error.message}`);
            }

      - name: Generate PR Token
        id: pr-token
        if: success() || failure()
        uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # v2.2.1
        with:
          app-id: ${{ secrets.NDTP_PULL_REQUEST_CONTROLLER_APP_CLIENT_ID }}
          private-key: ${{ secrets.NDTP_PULL_REQUEST_CONTROLLER_APP_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}
          repositories: |
            ${{ github.event.repository.name }}
          permission-pull-requests: write


      - name: Post Status Comment
        if: always()
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        env:
          JOB_STATUS: ${{ job.status }}
        with:
          github-token: ${{ steps.pr-token.outputs.token }}
          script: |
            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            const status = process.env.JOB_STATUS;
            const MARKER = '<!-- intermediate-merge-status-comment -->';
            
            let commentBody;
            
            if (status === 'success') {
              commentBody = `## ✅ Merge Success

              Upstream Sync PR Changes have been merged into \`develop\` via \`intermediate-sync\`.

              View the full [job summary↗️](${runUrl}) for details.
              ${MARKER}`;
            } else if (status === 'failure') {
              commentBody = `## ❌ Merge Failed

              The attempt to merge \`intermediate-sync\` into \`develop\` failed. This usually indicates a conflict or permission issue.

              View the [job summary↗️](${runUrl}) for failure details.
              ${MARKER}`;
            } else {
              return; // Do nothing for cancelled or other statuses
            }

            // Check for existing comments by the bot
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            // We use the hidden marker to identify the comment, which is robust and doesn't rely on bot user IDs
            const existingComment = comments.data.find(comment => comment.body.includes(MARKER));

            if (existingComment) {
              commentBody += '\n\n:recycle: This comment has been updated with the latest status.';
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: commentBody
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: commentBody
              });
            }
