# SPDX-License-Identifier: Apache-2.0
# © Crown Copyright 2026. This work has been developed by the National Digital Twin Programme and is legally attributed to the Department for Business and Trade (UK) as the governing entity.

name: Fork - Sync Upstream

on:
  schedule:
    # Sync nightly at 12:00 AM (midnight) UTC
    - cron: "0 0 * * *"
  workflow_dispatch: # Allow manual trigger

jobs:
  sync-upstream:
    if: github.event.repository.fork == true
    name: Sync to upstream-mirror branch
    runs-on: ubuntu-latest

    permissions:
      contents: write # Required to push changes

    steps:
      - name: Generate Sync Token
        id: sync-token
        uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # v2.2.1
        with:
          app-id: ${{ secrets.NDTP_REPOSITORY_WRITER_APP_CLIENT_ID }}
          private-key: ${{ secrets.NDTP_REPOSITORY_WRITER_APP_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}
          repositories: |
            ${{ github.event.repository.name }}
          permission-contents: write
          permission-workflows: write

      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0 # Fetch full history
          token: ${{ steps.sync-token.outputs.token }}

      - name: Configure Git
        env:
          GITHUB_APP_USERNAME: '${{ steps.sync-token.outputs.app-slug }}[bot]'
          GITHUB_APP_EMAIL: '${{ steps.sync-token.outputs.user-id }}+${{ steps.sync-token.outputs.app-slug }}[bot]@users.noreply.github.com'
        run: |
          git config user.name "$GITHUB_APP_USERNAME"
          git config user.email "$GITHUB_APP_EMAIL"

      - name: Determine upstream details
        id: upstream-details
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          script: |
            const { owner, repo } = context.repo;

            const parent =
              context.payload?.repository?.parent ??
              (await github.rest.repos.get({ owner, repo })).data?.parent ??
              null;

            if (!parent) {
              core.setFailed("No parent repository found. Ensure this repository is a fork.");
              return; 
            }

            console.log(`Detected URL: ${parent.clone_url}`);
            console.log(`Detected Branch: ${parent.default_branch}`);

            core.setOutput('clone_url', parent.clone_url);
            core.setOutput('default_branch', parent.default_branch);

      - name: Add upstream remote
        env:
          UPSTREAM_URL: ${{ steps.upstream-details.outputs.clone_url }}
        run: |
          if [ -z "$UPSTREAM_URL" ] || [ "$UPSTREAM_URL" = "null" ]; then
            echo "::error::Could not determine upstream repository URL. Ensure this repository is a fork."
            exit 1
          fi

          echo "Found upstream URL: $UPSTREAM_URL"

          # Add or update the upstream remote
          if git remote | grep -q "^upstream$"; then
            git remote set-url upstream "$UPSTREAM_URL"
          else
            git remote add upstream "$UPSTREAM_URL"
          fi

          git remote -v

      - name: Fetch upstream
        env:
          UPSTREAM_DEFAULT_BRANCH: ${{ steps.upstream-details.outputs.default_branch }}
        run: |
          git fetch upstream $UPSTREAM_DEFAULT_BRANCH -f --no-tags

      - name: Sync upstream-mirror
        env:
          UPSTREAM_DEFAULT_BRANCH: ${{ steps.upstream-details.outputs.default_branch }}
        run: |
          # Checkout (and create if needed) upstream-mirror based on upstream default branch
          git checkout -B upstream-mirror upstream/$UPSTREAM_DEFAULT_BRANCH

          # Force push to origin
          git push origin upstream-mirror --force

      - name: Summary
        if: success()
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        env:
          UPSTREAM_DEFAULT_BRANCH: ${{ steps.upstream-details.outputs.default_branch }}
        with:
          script: |
            const branchName = 'upstream-mirror';
            const upstreamDefaultBranch = process.env.UPSTREAM_DEFAULT_BRANCH;
            const gitHubRepository = process.env.GITHUB_REPOSITORY;

            // Get latest commit info
            let latestCommit = '';
            await exec.exec('git', ['log', '-1', branchName], {
              listeners: {
                stdout: (data) => {
                  latestCommit += data.toString();
                }
              }
            });

            const syncTime = new Date().toISOString().replace('T', ' ').substring(0, 19) + ' UTC';

            await core.summary
              .addRaw('## ✅ Sync Successful\n\n')
              .addRaw(`Successfully synced upstream DataHub ${upstreamDefaultBranch} to \`${branchName}\` branch.\n\n`)
              .addRaw(`**Sync Time:** ${syncTime}\n\n`)
              .addRaw('**Latest Commit:**\n')
              .addRaw('```\n')
              .addRaw(`${latestCommit.trim()}\n`)
              .addRaw('```\n\n')
              .addRaw(`**Branch:** [${branchName}](/${gitHubRepository}/tree/${branchName})\n`)
              .write();

            core.info(`Successfully synced upstream/${upstreamDefaultBranch} to ${branchName} branch`);
            core.info(`Latest commit on ${branchName}: ${latestCommit.trim()}`);
